<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfica con Valores y Porcentajes</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  <!-- Incluir jsPDF -->
    <style>
        /* Ajustamos el tamaño del contenedor */
        #chart-container {
            width: 100%;
            height: 300px;
        }

        #myChart {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }
    </style>
    <%- include('partials/head') %>
</head>
<body>
<%- include('partials/navigation') %>  

<div class="content">
    <h2 id="textoPregunta" style="color: blue; text-align: center;"></h2>

    <div class="register-formIzq1"> 
        <div id="chart-container">
            <canvas id="myChart"></canvas>
        </div><br>
    </div>    

    <!-- Mostrar la suma de los votos -->
    <p id="sumaVotos" style="text-align: center; font-size: 18px; color: blue;"></p>  <!-- Aquí se mostrará la suma de los votos -->

    <button id="download-pdf" class="btn btn-primary" hidden>Generar PDF</button> <!-- Botón para generar PDF -->

    <br><br>
    <a href="/resultados" class="btn btn-success btn-sm btnind-hover-effect">Regresar</a>
</div>    

<script>
    // Obtener los parámetros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const textoPregunta = urlParams.get('texto');  

    // Mostrar el texto de la pregunta en el HTML
    document.getElementById('textoPregunta').textContent = textoPregunta;  

    const labels = <%- JSON.stringify(labels) %>;
    const dataValues = <%- JSON.stringify(dataValues) %>;

    const total = dataValues.reduce((a, b) => a + b, 0);  // Suma total de votos
    const dataPercentage = dataValues.map(value => ((value / total) * 100).toFixed(2));  // Porcentajes

    // Mostrar la suma de los votos en el HTML
    document.getElementById('sumaVotos').textContent = `Suma total de votos: ${total}`;

    const vibrantColors = [
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)',
        'rgba(255, 99, 71, 0.6)',
        'rgba(100, 149, 237, 0.6)',
        'rgba(0, 255, 0, 0.6)',
        'rgba(255, 215, 0, 0.6)'
    ];

    const minIndex = dataValues.indexOf(Math.min(...dataValues));
    const maxIndex = dataValues.indexOf(Math.max(...dataValues));

    const backgroundColors = labels.map((_, index) => {
        if (index === minIndex) {
            return 'rgba(255, 0, 0, 0.6)';
        }
        if (index === maxIndex) {
            return 'rgba(0, 255, 0, 0.6)';
        }
        return vibrantColors[index % vibrantColors.length];
    });

    const borderColors = backgroundColors.map(color => color.replace('0.6', '1'));

    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Votos',
                data: dataValues,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            aspectRatio: 1.5,
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                datalabels: {
                    color: 'black',
                    anchor: 'start',
                    align: 'end',
                    offset: 20,
                    formatter: function(value, context) {
                        const percentage = dataPercentage[context.dataIndex];
                        return `Votos: ${value}\n\n${percentage}%`;
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            weight: 'bold',
                            size: 14,
                            color: 'blue'
                        }
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    beginAtZero: true
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Función para generar el PDF
    document.getElementById('download-pdf').addEventListener('click', function() {
        const canvas = document.getElementById('myChart');
        const imageData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.addImage(imageData, 'PNG', 10, 10, 180, 100);
        doc.setFontSize(18);
        doc.text(textoPregunta, 10, 120);
        doc.text(`Suma total de votos: ${total}`, 10, 130);  // Mostrar la suma en el PDF

        doc.save('grafica.pdf');
    });
</script>

<%- include('partials/footer') %>  
</body>
</html>
