<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">  
  <title>Captura de Firma</title>
  <link rel="stylesheet" href="/css/style.css">
<!-- Bootstrap 5.3.3 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Bootstrap 5.3.3 JS Bundle (incluye Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    #signatureCanvas {
      border: 1px solid #000;
      touch-action: none;
    }

    /* moviles */
    @media (max-width: 600px) {
      body {
        font-size: 16px;
        padding: 10px;
      }
    }

    /* Para pantallas medianas (tablets) */
    @media (min-width: 601px) and (max-width: 1024px) {
      body {
        font-size: 18px;
      }
    }    

    .container {
      width: 90%;      /* en lugar de usar px */
      max-width: 1200px;
      margin: auto;
    }

    .display-flex {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    img, video {
      max-width: 100%;
      height: auto;
    }
    /* f moviles */

    @media (max-width: 600px) {
      .firma-wrapper {
        overflow-x: auto;
        display: block;
      }

      .firma-wrapper > div {
        min-width: 420px; /* ancho mínimo para que canvas y firma entren sin romperse */
      }

      canvas,
      #firmaGuardadaImg {
        width: 100% !important;
        height: auto !important;
      }
    }    

  </style>
</head>
<body>
  <div id="activities" style="
    border: 2px solid #f0f8ff;
    padding: 4px;
    border-radius: 6px;
    background-color: #aa2323;
    width: 100%;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    gap: 20px; /* Espacio entre botón y título */
  ">
    <a id="regresarLink" class="regresar-link" style="margin-left: 20px;">Regresar</a>

    <div style="margin-left: auto; padding-right: 20px;">
      <h4 style="margin: 0; color: #ffffff;">Moldes JR</h4>
    </div> 
  </div>

    <div class="register-formAncho" style="text-align: center;">       
        <b>Firma Auxiliar</b>
        <hr>
        <form id="firmaForm" method="POST" action="/guardar-firmaux">
            <div class="row mb-3">
                <div class="col-auto">
                <label for="fecha" class="form-label">Fecha</label>
                <input 
                    type="text" 
                    id="fecha" 
                    name="fecha" 
                    class="form-control form-control-sm" 
                    readonly 
                    style="width: 160px; background-color: #fff3cd; color: #856404; font-weight: bold;"
                >
                </div>

                <div class="col-auto">
                <input 
                    type="hidden" 
                    id="tip_func" 
                    name="tip_func" 
                    class="form-control form-control-sm" 
                    readonly 
                    style="width: 150px; background-color: #e9f7ef; color: #1d643b; font-weight: bold;"
                >
                </div>

                <div class="col-auto">
                <label for="doc_id" class="form-label">Documento ID</label>
                <input 
                    type="text" 
                    id="doc_id" 
                    name="doc_id" 
                    class="form-control form-control-sm" 
                    readonly 
                    style="width: 200px; background-color: #e8f0fe; color: #0d3c61; font-weight: bold;"
                >
                </div>
            </div>
            <div class="firma-wrapper">
                        <div style="display: flex; gap: 20px; align-items: flex-start;">
                        <div>
                            <label for="signatureCanvas">Firma:</label><br>
                            <canvas id="signatureCanvas" width="400" height="200" style="border: 1px solid #000;"></canvas><br>
                        </div>
                            <div id="firmaGuardadaContainer" style="margin-top: 0;">
                                <label>Firma Guardada:</label><br>
                                <img id="firmaGuardadaImg" src="" alt="Firma guardada" style="border: 1px solid #ccc; width: 400px; height: 200px;">
                            </div>
                        </div>
            </div>
            <button type="button" onclick="limpiarFirma()">Limpiar Firma</button><br><br>
            <input type="hidden" name="firma" id="firmaInput">
            <button type="submit">Enviar</button>
        </form>
    </div>




<script>
  // Función para obtener los parámetros de la URL
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // Obtener los valores
  const tipFuncValue = getQueryParam("tip_func");
  const docIdValue = getQueryParam("doc_id");
  const fechaValue = getQueryParam("fecha");

  // Asignarlos a los inputs
  if (tipFuncValue) {
    document.getElementById("tip_func").value = tipFuncValue;
  }

  if (docIdValue) {
    document.getElementById("doc_id").value = docIdValue;
  }

  if (fechaValue) {
    document.getElementById("fecha").value = fechaValue;
  }

    // Cargar la firma guardada desde el servidor (si existe)
  if (tipFuncValue && docIdValue && fechaValue) {
    fetch(`/obtener-firmaux?tip_func=${tipFuncValue}&doc_id=${docIdValue}&fecha=${fechaValue}`)
      .then(res => res.json())
      .then(data => {
        if (data.firmaBase64) {
          document.getElementById("firmaGuardadaImg").src = data.firmaBase64;
        }
      });
  }

  // Asignar href dinámico al botón Regresar
  const regresarLink = document.getElementById("regresarLink");
  if (regresarLink && tipFuncValue && docIdValue && fechaValue) {
    const regresarUrl = `/detalle-diaux?fecha=${encodeURIComponent(fechaValue)}&tip_func=${encodeURIComponent(tipFuncValue)}&doc_id=${encodeURIComponent(docIdValue)}`;
    regresarLink.href = regresarUrl;
  }  
</script>

  <script>
const canvas = document.getElementById('signatureCanvas');
const ctx = canvas.getContext('2d');
let isDrawing = false;

// Mouse Events
canvas.addEventListener('mousedown', (e) => {
  isDrawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});

canvas.addEventListener('mousemove', (e) => {
  if (isDrawing) {
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  }
});

canvas.addEventListener('mouseup', () => {
  isDrawing = false;
});

// Touch Events (para móviles)
canvas.addEventListener('touchstart', (e) => {
  e.preventDefault();
  if (e.touches.length > 0) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    isDrawing = true;
    ctx.beginPath();
    ctx.moveTo(x, y);
  }
});

canvas.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (isDrawing && e.touches.length > 0) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    ctx.lineTo(x, y);
    ctx.stroke();
  }
});

canvas.addEventListener('touchend', () => {
  isDrawing = false;
});


    canvas.addEventListener('mouseup', () => {
      isDrawing = false;
    });

    function limpiarFirma() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

document.getElementById('firmaForm').addEventListener('submit', function (e) {
  // Obtener la imagen de la firma en base64
  const firmaData = canvas.toDataURL('image/png');

  // Validar si el canvas está vacío
  if (firmaData === 'data:image/png;base64,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') 
  {
    e.preventDefault();
    alert("Debe firmar antes de enviar.");
    return false;
  }

  // Si no está vacío, asignar el valor y dejar enviar
  document.getElementById('firmaInput').value = firmaData;
});

  </script>
</body>
</html>
