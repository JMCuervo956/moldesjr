<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <title>Asamblea</title>
    <%- include('partials/head') %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <%- include('partials/navigation') %>  
    <div class="content">
        <div class="register-formAncho">
            <div class="container mt-1">
                <table class="table table-bordered table-hover">
                    <thead>
                        <th>
                            <h4 style="text-align: center; color: rgb(214, 10, 20);">Seleccionar Pregunta para Votar</h4>
                            <a href="/menuprc" class="btn btn-success btn-sm btnind-hover-effect">Continuar</a>
                        </th>
                    </thead>        
                </table>
            </div>
            <div class="container mt-1">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr style="font-size: 8px; text-align: center;">
                            <th></th>
                            <th># Opc</th>
                            <th style="font-size: 8px; text-align: center;">Estado<br>"0" No Disponible</th>
                        </tr>                        
                    </thead>
                    <tbody>
                        <% if (data && data.length > 0) { %>
                            <% data.forEach(function(item) { %>
                                <tr id="item-<%= item.id %>" data-id="<%= item.id %>">
                                    <td class="tex-hover-effect <%= item.opc === 0 ? 'red-text' : '' %>">
                                        <%= item.texto %>
                                    </td>
                                    <td class="tex-hover-effect <%= item.opc === 0 ? 'red-text' : '' %>">
                                        <%= item.opc %>
                                    </td>

                                    <td>
                                        <button class="btn btn-link btn-sm btn-hover-effect toggle-estado" data-id="<%= item.id %>" data-estado="<%= item.estado %>">
                                            <%= item.estado === 1 ? 'Desactivar' : 'Activar' %>
                                        </button>
                                    </td>
                                    <td>
                                        <div>
                                            <label style="color: <%= item.estado === 0 ? 'red' : 'green' %>; text-align: center; display: block;">
                                                <%= item.estado %>
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %> 
                            <tr>
                                <td colspan="3">No hay datos disponibles</td>   
                            </tr>
                        <% } %>
                    </tbody>
                    

                </table>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>

$(document).ready(function() {
    // Manejar el cambio de estado (activo/inactivo)
    $('.toggle-estado').click(function() {
        const id = $(this).data('id');
        const estadoActual = $(this).data('estado');
        const nuevoEstado = estadoActual === 1 ? 0 : 1; // Alternar entre 1 y 0

        // Si se va a activar (nuevoEstado es 1), desactivar todos los demás
        if (nuevoEstado === 1) {
            // Desactivar todos los demás
            $('.toggle-estado').each(function() {
                const otherId = $(this).data('id');
                if (otherId !== id) {
                    // Actualizar el estado a 0
                    $.ajax({
                        url: '/actualizarEstado', // La URL de tu servidor para actualizar el estado
                        method: 'POST',
                        data: {
                            id: otherId,
                            estado: 0
                        },
                        success: function(response) {
                            if (response.status === 'success') {
                                // Actualizar la interfaz
                                const fila = $('#item-' + otherId);
                                fila.find('.toggle-estado').text('Activar');
                                fila.find('.toggle-estado').data('estado', 0);

                                const estadoCelda = fila.find('td:last label');
                                estadoCelda.text(0);
                                estadoCelda.css('color', 'red');
                            } else {
                                Swal.fire('Error', 'Error al desactivar otros elementos', 'error');
                            }
                        },
                        error: function() {
                            Swal.fire('Error', 'Hubo un problema con la solicitud', 'error');
                        }
                    });
                }
            });
        }

        // Realizar la solicitud AJAX para actualizar el estado del item seleccionado
        $.ajax({
            url: '/actualizarEstado', // La URL de tu servidor para actualizar el estado
            method: 'POST',
            data: {
                id: id,
                estado: nuevoEstado
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Actualizar la interfaz después de la respuesta exitosa
                    const fila = $('#item-' + id);
                    fila.find('.toggle-estado').text(nuevoEstado === 1 ? 'Desactivar' : 'Activar');
                    fila.find('.toggle-estado').data('estado', nuevoEstado);

                    // Actualizar el estado en la celda
                    const estadoCelda = fila.find('td:last label');
                    estadoCelda.text(nuevoEstado); // Actualizar el valor del estado
                    estadoCelda.css('color', nuevoEstado === 1 ? 'green' : 'red');
                } else {
                    Swal.fire('Error', 'Error al actualizar el estado', 'error');
                }
            },
            error: function() {
                Swal.fire('Error', 'Hubo un problema con la solicitud', 'error');
            }
        });
    });
});


    </script>

</body>
</html>
